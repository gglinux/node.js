/**
 *
 * 定义全局常用变量，处理静态文件，设置过期时间
 */
var BASE_DIR = __dirname,
	CONF     = BASE_DIR + '/conf/',
	CACHE_TIME = 60*60*24*365,
	mmieConf;
/**
 *
 * require本模块需要的Node.js模块
 */
var sys = require('util'),
	http = require('http'), 
	fs    = require('fs'),
	url   = require('url'),
	path  = require('path');
	mmieConf = getMmieConf();

/**
 *
 * 响应静态资源请求
 * @param string pathname
 * @param object res
 * @return null
 */
exports.getStaticFile = function(pathname, res, req, staticPath){
	//返回制定文件的拓展名
	// console.log(pathname);
	var extname = path.extname(pathname);
	// console.log('????????'+extname.slice(1));
	// console.log('!!!!!'+extname);
	// 如果extname不存在的话，就将其制空，否则将其置为后缀名
	extname  = extname  ? extname.slice(1) : '';
	// console.log(extname.slice(1));
	var realPath = staticPath + pathname;
	//查看是否存在拓展名，存在的话，就取拓展名，不存在就置为text类型
	var mmieType = mmieConf[extname] ? mmieConf[extname] : 'text/plain';
	// console.log('********'+realPath);
	fs.exists(realPath, function (exists) {
        if (!exists) {
            // res.writeHead(404, {'Content-Type': 'text/plain'});
            // res.write("This request URL " + pathname + " was not found on this server.");
            res.end("This request URL " + pathname + " was not found on this server.");
            return;
        } else {
			var fileInfo = fs.statSync(realPath);
			//得到最后一次的修改时间
			var lastModified = fileInfo.mtime.toUTCString();
			/* 存在该文件的后缀名设置缓存 */
			if ( mmieConf[extname]) {
				var date = new Date();
				date.setTime(date.getTime() + CACHE_TIME * 1000);
				// res.setHeader("Expires", date.toUTCString());
				// res.setHeader("Cache-Control", "max-age=" + CACHE_TIME);
			}
			// console.log('**********'+req.headers['if-modified-since']);
			//判断是否被修改，如果没有修改，则返回304（文件最后一次修改的时间是否相等）
			if (req.headers['if-modified-since'] && lastModified == req.headers['if-modified-since']) {
                    // res.writeHead(304, "Not Modified");
                    res.end();
                    return;
            } else {
				
					fs.readFile(realPath, "binary", function(err, file) {
						if (err) {
							// res.writeHead(500, {'Content-Type': 'text/plain'});
							res.end(err);
							return;
						} else {
						// res.setHeader("Last-Modified", lastModified);
						res.writeHead(200, {'Content-Type': mmieType});
						// res.write(file, "binary");
						res.end(file,"binary");
						// return;
					}
             });
          }
		}
      });
}
//获取MMIE配置信息，读取配置文件
function getMmieConf(){
    var routerMsg = {};
    try{
        var str = fs.readFileSync(CONF + 'mmie_type.json','utf8');
        routerMsg = JSON.parse(str);
    }catch(e){
        sys.debug("JSON parse fails")
    }
    return routerMsg;
}
